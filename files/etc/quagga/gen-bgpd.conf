#!/bin/bash

IM=icvpn-meta
CONF=bgpd.conf

echo "clone repository"
rm -rf $IM
git clone https://github.com/freifunk/icvpn-meta.git

echo "remove unneeded files"
rm $IM/README*

echo "generate $CONF"

cat<<EOM >$CONF
! Config file $CONF was generated by gen-bgpd.conf
! autor: stephan enderlein
!
! own settings
hostname localhost
password icvpn 
router bgp 650xx
bgp router-id 10.207.x.y
network 10.200.0.0/16

!
 neighbor icvpn4 peer-group
 neighbor icvpn4 soft-reconfiguration inbound
 neighbor icvpn4 prefix-list icvpn4 in
 neighbor icvpn4 prefix-list icvpn4 out

! ipv4
EOM

for city in $(ls -1 $IM)
do

 #ignore dresden
 test "$city" = "dresden" && echo ": ignore $city" && continue

 echo "ipv4: process $city"

 # process ipv4
  cat $IM/$city | awk '
	/^[ 	]*$/{next}
	/^asn:/{ asn=$2;}

	/^bgp:/,/^[ 	]/{
	 	while(getline>0)
		{
			if(match($0,"^[ 	]+ipv4:.*")==0 && match($0,"^[ 	]+ipv6:.*")==0)
			{
				name=$1
				gsub(/:/,"",name)
				continue
			}

			if(match($0,"^[ 	]+ipv4:.*"))
			{
				ip=$2
				print "neighbor "ip" remote-as "asn
				print "neighbor "ip" description "name
				print "neighbor "ip" peer-group icvpn4"
				print ""
				continue	
			}

			if(match($0,"^[ 	]+ipv6:.*"))
			{
				continue
			}

		}
		
	}
  ' >>$CONF
done



#-------------  process ipv6


cat<<EOM >>$CONF
 


 address-family ipv6
!
! Here you can specify the networks you are using.
! network fec0:123::/128
!
 neighbor icvpn6 peer-group
 neighbor icvpn6 activate
 neighbor icvpn6 prefix-list icvpn6 in
 neighbor icvpn6 prefix-list icvpn6 out
!
EOM


for city in $(ls -1 $IM)
do

 #ignore dresden
 test "$city" = "dresden" && echo ": ignore $city" && continue

 echo "ipv6: process $city"

  cat $IM/$city | awk '
	/^[ 	]*$/{next}
	/^asn:/{ asn=$2;}

	/^bgp:/,/^[ 	]/{
	 	while(getline>0)
		{
			if(match($0,"^[ 	]+ipv4:.*")==0 && match($0,"^[ 	]+ipv6:.*")==0)
			{
				name=$1
				gsub(/:/,"",name)
				continue
			}

			if(match($0,"^[ 	]+ipv6:.*"))
			{
				ip=$2
				print "neighbor "ip" remote-as "asn
				print "neighbor "ip" description "name
				print "neighbor "ip" peer-group icvpn4"
				print ""
				continue	
			}

			if(match($0,"^[ 	]+ipv4:.*"))
			{
				continue
			}

		}
		
	}
  ' >>$CONF

done


cat<<EOM >>$CONF

ip prefix-list icvpn4 description *** ICVPN prefix-list for internal and public IP address space ***
!
! deny the default gateway route
!
ip prefix-list icvpn4 seq 10 deny 0.0.0.0/0
!
! permit RFC1918 networks
!
ip prefix-list icvpn4 seq 20 permit 10.0.0.0/8 le 24
ip prefix-list icvpn4 seq 21 permit 172.16.0.0/12 le 24
ip prefix-list icvpn4 seq 22 permit 192.168.0.0/16 le 24
!
! deny all others
!
ip prefix-list icvpn4 seq 999 deny 0.0.0.0/0 le 32
!
 ipv6 prefix-list icvpn6 permit 2000::/3 le 64
 ipv6 prefix-list icvpn6 deny any
!
log file /var/log/quagga/bgpd.log
!
!log stdout
EOM

